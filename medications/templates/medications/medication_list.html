{% extends 'medications/base.html' %}

{% block title %}My Medications - Medication Reminder{% endblock %}

{% block header %}üíä My Medications{% endblock %}

{% block content %}
<div class="main-content">
    <div class="mb-3">
        <a href="{% url 'medications:add_medication' %}" class="btn btn-primary">‚ûï Add New Medication</a>
    </div>

    <!-- Statistics Dashboard -->
    <div class="dashboard-stats">
        <h3>üìä Dashboard Statistics</h3>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number" style="color: #667eea;">{{ total_medications }}</div>
                <div class="stat-label">Total</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" style="color: #f39c12;">{{ pending_count }}</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" style="color: #56ab2f;">{{ taken_count }}</div>
                <div class="stat-label">Taken</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" style="color: #74b9ff;">{{ today_count }}</div>
                <div class="stat-label">Today</div>
            </div>
            {% if overdue_count > 0 %}
            <div class="stat-item">
                <div class="stat-number" style="color: #ff416c;">{{ overdue_count }}</div>
                <div class="stat-label">‚ö†Ô∏è Overdue</div>
            </div>
            {% endif %}
        </div>
        <div style="text-align: center; margin-top: 10px; color: #666; font-size: 14px;">
            Last updated: {{ current_time|date:"M d, Y \a\t H:i" }}
        </div>
    </div>

<!-- Pending Medications -->
<h2>Pending Medications (Page {{ pending_medications.number }} of {{ pending_medications.paginator.num_pages }})</h2>
{% if pending_medications %}
    {% for medication in pending_medications %}
        <div class="medication-card {% if medication.is_overdue %}overdue{% endif %}">
            <h4>{{ medication.name }}</h4>
            <p><strong>Dosage:</strong> {{ medication.dosage }}</p>
            <p><strong>Scheduled:</strong> {{ medication.scheduled_datetime|date:"M d, Y \a\t H:i" }}
                {% if medication.is_overdue %}
                    <span style="color: #dc3545; font-weight: bold;">(OVERDUE)</span>
                {% endif %}
            </p>
            <p><strong>Status:</strong> <span style="color: #ffc107;">{{ medication.get_status_display }}</span></p>
            
            <div class="medication-actions">
                <!-- Mark as Taken Form -->
                <form method="post" action="{% url 'medications:mark_as_taken' medication.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm" onclick="return confirm('Mark {{ medication.name }} as taken?')">Mark as Taken</button>
                </form>
                
                <a href="{% url 'medications:edit_medication' medication.id %}" class="btn btn-primary btn-sm">Edit</a>
                
                <!-- Delete Form -->
                <form method="post" action="{% url 'medications:delete_medication' medication.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete {{ medication.name }}?')">Delete</button>
                </form>
            </div>
        </div>
    {% endfor %}
    
    <!-- Pending Medications Pagination -->
    {% if pending_medications.paginator.num_pages > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if pending_medications.has_previous %}
                <a href="?pending_page=1{% if request.GET.taken_page %}&taken_page={{ request.GET.taken_page }}{% endif %}" class="pagination-btn">¬´ First</a>
                <a href="?pending_page={{ pending_medications.previous_page_number }}{% if request.GET.taken_page %}&taken_page={{ request.GET.taken_page }}{% endif %}" class="pagination-btn">‚Äπ Previous</a>
            {% endif %}
            
            <span class="pagination-info">
                Page {{ pending_medications.number }} of {{ pending_medications.paginator.num_pages }}
            </span>
            
            {% if pending_medications.has_next %}
                <a href="?pending_page={{ pending_medications.next_page_number }}{% if request.GET.taken_page %}&taken_page={{ request.GET.taken_page }}{% endif %}" class="pagination-btn">Next ‚Ä∫</a>
                <a href="?pending_page={{ pending_medications.paginator.num_pages }}{% if request.GET.taken_page %}&taken_page={{ request.GET.taken_page }}{% endif %}" class="pagination-btn">Last ¬ª</a>
            {% endif %}
        </div>
        <div class="pagination-summary">
            Showing {{ pending_medications.start_index }}-{{ pending_medications.end_index }} of {{ pending_medications.paginator.count }} pending medications
        </div>
    </div>
    {% endif %}
{% else %}
    <div class="no-medications">
        <p>No pending medications. <a href="{% url 'medications:add_medication' %}">Add your first medication</a>!</p>
    </div>
{% endif %}

<!-- Taken Medications -->
<h2>Recently Taken Medications (Page {{ taken_medications.number }} of {{ taken_medications.paginator.num_pages }})</h2>
{% if taken_medications %}
    {% for medication in taken_medications %}
        <div class="medication-card taken">
            <h4>{{ medication.name }}</h4>
            <p><strong>Dosage:</strong> {{ medication.dosage }}</p>
            <p><strong>Was Scheduled:</strong> {{ medication.scheduled_datetime|date:"M d, Y \a\t H:i" }}</p>
            <p><strong>Status:</strong> <span style="color: #28a745;">{{ medication.get_status_display }}</span> ‚úì</p>
            <p><strong>Updated:</strong> {{ medication.updated_at|date:"M d, Y \a\t H:i" }}</p>
            
            <div class="medication-actions">
                <a href="{% url 'medications:edit_medication' medication.id %}" class="btn btn-primary btn-sm">Edit</a>
                
                <!-- Delete Form -->
                <form method="post" action="{% url 'medications:delete_medication' medication.id %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete {{ medication.name }}?')">Delete</button>
                </form>
            </div>
        </div>
    {% endfor %}
    
    <!-- Taken Medications Pagination -->
    {% if taken_medications.paginator.num_pages > 1 %}
    <div class="pagination-container">
        <div class="pagination">
            {% if taken_medications.has_previous %}
                <a href="?taken_page=1{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="pagination-btn">¬´ First</a>
                <a href="?taken_page={{ taken_medications.previous_page_number }}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="pagination-btn">‚Äπ Previous</a>
            {% endif %}
            
            <span class="pagination-info">
                Page {{ taken_medications.number }} of {{ taken_medications.paginator.num_pages }}
            </span>
            
            {% if taken_medications.has_next %}
                <a href="?taken_page={{ taken_medications.next_page_number }}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="pagination-btn">Next ‚Ä∫</a>
                <a href="?taken_page={{ taken_medications.paginator.num_pages }}{% if request.GET.pending_page %}&pending_page={{ request.GET.pending_page }}{% endif %}" class="pagination-btn">Last ¬ª</a>
            {% endif %}
        </div>
        <div class="pagination-summary">
            Showing {{ taken_medications.start_index }}-{{ taken_medications.end_index }} of {{ taken_medications.paginator.count }} taken medications
        </div>
    </div>
    {% endif %}
{% else %}
    <div class="no-medications">
        <p>No medications marked as taken yet.</p>
    </div>
{% endif %}
</div>
{% endblock %}
